<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºè°±AI Tokenä½¿ç”¨é‡ç»Ÿè®¡å·¥å…·</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>æ™ºè°±AI Token ä½¿ç”¨é‡ç»Ÿè®¡å·¥å…·</h1>
            <p class="subtitle">ç­›é€‰èµ„æºåŒ…: <strong>{{ bundle_name }}</strong></p>
        </header>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <p>æ‹–æ‹½xlsxæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
                <button class="btn btn-primary" id="selectBtn">é€‰æ‹©æ–‡ä»¶</button>
            </div>
            <div class="file-info" id="fileInfo" style="display: none;">
                <span id="fileName"></span>
                <button class="btn btn-success" id="analyzeBtn">åˆ†ææ•°æ®</button>
            </div>
        </div>

        <!-- åŠ è½½ä¸­ -->
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>æ­£åœ¨åˆ†ææ•°æ®...</p>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div class="error-message" id="errorMessage" style="display: none;"></div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <!-- æ€»è®¡ä¿¡æ¯ -->
            <div class="summary-card">
                <h3>æ€»è®¡</h3>
                <div class="total-tokens">
                    <span id="grandTotal">0</span>
                    <span class="unit">tokens</span>
                </div>
            </div>

            <!-- æŒ‰API Keyåˆ†ç»„çš„ç»“æœ -->
            <div id="apiKeysContainer"></div>

            <!-- å¯¼å‡ºæŒ‰é’® -->
            <div class="export-section">
                <button class="btn btn-export" id="exportCsvBtn">å¯¼å‡º CSV</button>
                <button class="btn btn-export" id="exportExcelBtn">å¯¼å‡º Excel</button>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;

        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const apiKeysContainer = document.getElementById('apiKeysContainer');
        const grandTotal = document.getElementById('grandTotal');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
        selectBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ‹–æ‹½äº‹ä»¶
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showError('è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsï¼‰');
                return;
            }
            fileName.textContent = file.name;
            fileInfo.style.display = 'flex';
            errorMessage.style.display = 'none';
            resultsSection.style.display = 'none';
        }

        // åˆ†ææŒ‰é’®
        analyzeBtn.addEventListener('click', async () => {
            const file = fileInput.files[0] || await getFileFromName(fileName.textContent);
            if (!file) {
                showError('è¯·é‡æ–°é€‰æ‹©æ–‡ä»¶');
                return;
            }
            uploadFile(file);
        });

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile(file) {
            loading.style.display = 'flex';
            errorMessage.style.display = 'none';
            resultsSection.style.display = 'none';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                loading.style.display = 'none';

                if (result.success) {
                    currentData = result;
                    displayResults(result);
                } else {
                    showError(result.error);
                }
            } catch (error) {
                loading.style.display = 'none';
                showError('ä¸Šä¼ æ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data) {
            resultsSection.style.display = 'block';
            grandTotal.textContent = formatNumber(data.grand_total);

            // æ¸…ç©ºå®¹å™¨
            apiKeysContainer.innerHTML = '';

            // æŒ‰API Keyæ˜¾ç¤º
            for (const [apiKey, keyData] of Object.entries(data.data)) {
                const card = createApiKeyCard(apiKey, keyData, data.dates, data.grand_total);
                apiKeysContainer.appendChild(card);
            }
        }

        // åˆ›å»ºAPI Keyå¡ç‰‡
        function createApiKeyCard(apiKey, keyData, dates, grandTotal) {
            const card = document.createElement('div');
            card.className = 'api-key-card';

            // è®¡ç®—ç™¾åˆ†æ¯”
            const percentage = grandTotal > 0 ? ((keyData.total / grandTotal) * 100).toFixed(2) : 0;

            // æ ‡é¢˜
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `
                <h3>API Key: <code>${apiKey}</code></h3>
                <div class="subtotal">
                    å°è®¡: <strong>${formatNumber(keyData.total)}</strong> tokens
                    <span class="percentage">(${percentage}%)</span>
                </div>
            `;
            card.appendChild(header);

            // ç™¾åˆ†æ¯”è¿›åº¦æ¡
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
            `;
            card.appendChild(progressContainer);

            // è¡¨æ ¼
            const table = document.createElement('table');
            table.className = 'usage-table';

            // è¡¨å¤´
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th>æ—¥æœŸ</th><th>æ¨¡å‹</th><th>Tokenä½¿ç”¨é‡</th></tr>';
            table.appendChild(thead);

            // è¡¨ä½“
            const tbody = document.createElement('tbody');
            for (const date of dates) {
                if (keyData.daily[date]) {
                    const models = keyData.daily[date];
                    models.forEach((item, index) => {
                        const row = document.createElement('tr');
                        if (index === 0) {
                            row.innerHTML = `
                                <td rowspan="${models.length}">${date}</td>
                                <td>${item.model}</td>
                                <td>${formatNumber(item.usage)}</td>
                            `;
                        } else {
                            row.innerHTML = `
                                <td>${item.model}</td>
                                <td>${formatNumber(item.usage)}</td>
                            `;
                        }
                        tbody.appendChild(row);
                    });
                }
            }
            table.appendChild(tbody);
            card.appendChild(table);

            return card;
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // å¯¼å‡ºCSV
        exportCsvBtn.addEventListener('click', async () => {
            if (!currentData) return;

            const response = await fetch('/export/csv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentData)
            });

            const blob = await response.blob();
            downloadBlob(blob, `token_usage_${getDateString()}.csv`);
        });

        // å¯¼å‡ºExcel
        exportExcelBtn.addEventListener('click', async () => {
            if (!currentData) return;

            const response = await fetch('/export/excel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentData)
            });

            const blob = await response.blob();
            downloadBlob(blob, `token_usage_${getDateString()}.xlsx`);
        });

        // ä¸‹è½½æ–‡ä»¶
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // è·å–æ—¥æœŸå­—ç¬¦ä¸²
        function getDateString() {
            const now = new Date();
            return `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>
